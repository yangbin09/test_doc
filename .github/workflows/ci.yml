name: Continuous Integration

on:
  # 在推送到任何分支时触发
  push:
    branches: ['**']
  # 在创建 Pull Request 时触发
  pull_request:
    branches: [main, master]
  # 允许手动触发工作流
  workflow_dispatch:

jobs:
  # 代码质量检查作业
  quality-check:
    runs-on: ubuntu-latest
    name: Code Quality Check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          registry-url: 'https://registry.npmmirror.com'
      
      - name: Install dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          npm install
      
      - name: Run ESLint
        run: npm run lint
      
      - name: Run Prettier check
        run: npm run format:check
        continue-on-error: true
      
      - name: Build test
        run: npm run docs:build
      
      - name: Check build output
        run: |
          if [ ! -d ".vitepress/dist" ]; then
            echo "Build failed: dist directory not found"
            exit 1
          fi
          echo "Build successful: dist directory exists"
          ls -la .vitepress/dist/

  # 依赖安全检查
  security-check:
    runs-on: ubuntu-latest
    name: Security Check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          registry-url: 'https://registry.npmmirror.com'
      
      - name: Install dependencies
        run: |
          npm config set registry https://registry.npmmirror.com
          npm install
      
      - name: Run security audit
        run: |
          echo "Checking for known vulnerabilities..."
          echo "Note: npm audit is not supported with npmmirror registry"
          echo "Using alternative security check with npm ls"
          npm ls --depth=0
        continue-on-error: true